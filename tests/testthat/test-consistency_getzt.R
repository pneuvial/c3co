context("Consistency of the optimization algorithm")

test_that("Consistency of get.Z", {

  ## some random data  
  n <- 10
  J <- 11
  K <- 4
  lambda <- 0.01
  
  # Z <- matrix(1, nrow = K, ncol = J)
  # Z[2, 2]    <- 2
  # Z[3, 5:6]  <- 2
  # Z[4, 9:10] <- 2
  # 
  # W <- t(rmultinom(n, K, c(1/8,1/8,1/4,1/2))/4)
  # E <- matrix(rnorm(n*J, sd = 0.1), nrow = n, ncol = J)
  # Y <- W %*% Z + E

  Y <- matrix(
c(0.98897145056092261584, 0.94889904941933578275, 0.90888045833701891496,
0.91628283197310600450, 1.24158351784893405956, 1.01340882201520310346,
0.95093141033090566872, 0.95594521276467725457, 1.04595894410058543045,
0.93062797530625240849, 1.10517950896135275229, 1.30747557209007281287,
0.89763442770361212553, 1.24848616996358185993, 1.40640513988316051552,
1.11022975462002637670, 0.95244069211309423384, 0.92905599624874934950,
1.19987419394052396981, 1.08709065309212959960, 0.88323807379058139055,
0.78199603510513260307, 0.86590068078999715695, 0.97057061412362866104, 
0.95341024595938894670, 1.14494962652871312692, 0.89313572763254189812,
0.91446353662624924041, 0.97193769980425459565, 0.90056599237043344353,
0.90314856821279509980, 0.88926818073582336588, 0.87480141143610601340,
0.94761718810126438495, 0.95031500427333004399, 0.81939687431980512411,
0.94179240753106674422, 0.88911103755732190379, 0.89850379905079902354,
0.98376904764431805095, 1.30630558189945178427, 1.41478174728150607464,
1.42266465760563054488, 1.41059096288572960454, 0.88421914523055900048,
1.06565884643328079306, 1.50489910707178564664, 0.99652396101961626673,
1.18303664203380431985, 0.99923952442890251469, 1.42770844481434266982,
1.13613922632490904618, 1.63678271794232621517, 1.38295647907823604505,
1.03364727972038172865, 1.00068928384419586486, 1.20445312618385713677,
0.96334760671260666332, 1.31482865675031468378, 1.20702708613309428465,
0.98466015875330303864, 0.86092990532985091967, 0.92764182228898461879,
1.02582617621678529041, 0.96829408850388010155, 0.98222100423357061594,
0.98300059231454595121, 0.86276981141233055617, 0.98262128295859663130,
1.08502322571218834391, 1.06976087116682538891, 1.05499973510911004837,
0.95972680245523767084, 0.98084062295215235228, 0.88054721203974861687,
0.99468411812566759345, 1.02551960009958342823, 1.17059640072400750199,
1.10015132523634484585, 0.95044165569985394892, 1.53555502969997492713,
1.13653919564661531894, 1.58782036269522919270, 1.59729167533761229336,
1.71211171053756761040, 1.79145235343749864576, 1.70252815264706391929,
2.00659934937044592829, 1.44975222176061335766, 1.41740014128706648400,
1.51669892797529826112, 1.16037353737552417776, 1.51681853876557570793,
1.53549682610148541251, 1.49478948831288671606, 1.73040653812837463832,
1.68509302483942402517, 1.88902327686012672103, 1.58492742026550592627,
1.50223625260760229594, 1.08311406173068358605, 0.87557121486557720758,
1.01690264137661756649, 1.06731663069476789829, 0.99737236235514736826,
0.98086078314439761883, 0.92180933533001230273, 1.20581619877634915738, 
1.07505014531558318325, 1.18242083023782895701),
  n, J)
  
  W <- matrix(c(0.0, 0.25, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.25,
0.0, 0.25, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.25, 0.0, 0.5, 0.25, 0.5,
0.5, 0.0, 0.0, 0.5, 0.0, 0.25, 0.0, 0.5, 0.0, 0.5, 0.5, 0.5, 1.0, 0.5,
1.0, 0.5, 0.5), n, K)
  
  # require(CVXR)
  # 
  # ## solving with CVXR
  # lambda <- 0.01
  # Z_hat <- CVXR::Variable(K, J)
  # D <- as.matrix(
  #       bandSparse(
  #         J - 1, J, k = 1:0,
  #         list(rep(1, J-1), rep(-1, J))
  #       ))
  # loss <- CVXR::Minimize(sum((Y - W %*% Z_hat)^2) + lambda * sum(abs(D %*% t(Z_hat))))
  # problem   <- CVXR::Problem(loss)
  # result <- solve(problem)
  # Zt_star <- t(result$getValue(Z_hat))

  Zt_star <- matrix( c(1.64744608116284974031, 2.26932245559026624093,
                  1.56640511491961231805, 1.92959727036854111759,
                  2.37318160803829947270, 2.26812528546514080574,
                  1.99140567322015082929, 1.99140567057027673137,
                  1.99062331922777291382, 2.16723069805521273423,
                  2.14289780842337185263, 1.43593145251091547365,
                  1.76127707388283027967, 0.91869166139360025625,
                  0.92601244618100397865, 0.92601244633517887372,
                  0.97221726149275855544, 0.90634865918521723138,
                  0.90634865965853683711, 1.32804981627605700467,
                  1.20111173158299289199, 0.84888059896408529781,
                  0.87278803046712527536, 1.07137355790782073939,
                  0.79177677517967537391, 0.92731833363699978090,
                  1.86092936224212390783, 1.78097126922331483456,
                  0.97813370789995546239, 1.01709822429668239607,
                  1.27621608482902315629, 1.29897931710319070042,
                  0.90659329148683520661, 0.99724820518943557701,
                  1.02348472523406064383, 1.02348474145238554911,
                  0.88981178813747874301, 0.98139005533862244679,
                  1.04161306097664763115, 0.97181807004325870825,
                  1.04419536585372552118, 1.89511746962100202651,
                  1.82794335933250851056, 1.13534935026193650742),
                  J, K)
  ## solving with c3co (glmnet)
  WtWm1 <- tcrossprod(backsolve(qr.R(qr(W)), x = diag(K)))
  ## FIXME: include the penalty factor in get.Zt
  Zt_c3co <- c3co:::get.Zt(Y, lambda / (2*n*J) , W, WtWm1) 

  expect_lt(sum((Zt_star - Zt_c3co)^2), 1e-4)
})

